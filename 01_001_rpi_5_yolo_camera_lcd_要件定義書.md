# リアルタイム物体検出アプリ（Raspberry Pi 5 × YOLO × Camera V3 × 16×2 LCD）要件定義書

## 1. 目的
本アプリは、Raspberry Pi 5 と Raspberry Pi 公式カメラモジュール V3（以下、Camera V3）で取得した映像に対し、YOLO を用いてリアルタイムに物体検出を行い、検出した代表的なオブジェクト名（クラス名）を 16×2 文字 LCD（一般的な LCD1602 互換、I²C バックパック付）に表示することを目的とします。初心者でも再現可能な構成とし、Python を用いて開発します。

**本プロジェクトは初心者向けの教材であるため、なるべくシンプルな構成・コードで、可能な限り単一のPythonファイルで簡潔に実装することを基本方針とします。**

> 備考：ご要望の「1603LCD」は 16×2 文字 LCD（LCD1602 互換）を想定して記述しています（I²C バックパック付）。

## 2. スコープ
- カメラからの連続フレーム取得と物体検出
- 代表クラス名の LCD 表示（同時に複数検出時は優先順位ルールで 1〜2件表示）
- 最低限のログ出力（検出ログ、FPS、エラー）
- ユーザー操作：起動・終了（CLI）
- ヘッドレス運用（モニターなし）に対応

※ 以下はスコープ外：学習データの収集・再学習、Web UI の提供、動画保存（必要に応じ将来対応）

## 3. 成果物
- **実行可能な単一 Python スクリプト（`yolo_picamera_detector.py`）** - 教材として理解しやすい構成
- 依存関係ファイル（`requirements.txt`）
- セットアップ手順書、配線図、README（再現可能性を担保）
- 起動用 systemd ユニット（任意、`deploy/rpi5-yolo.service`）

※ 設定項目は可能な限りスクリプト内定数として定義し、外部設定ファイルは使用しない方針

## 4. 利用者・想定環境
- 想定ユーザー：Raspberry Pi・Python 初学者〜中級者
- 実行環境：Raspberry Pi OS (64-bit) on Raspberry Pi 5、Python 3.11 以上推奨

## 5. ハードウェア要件
### 5.1 必須
- Raspberry Pi 5（電源 27W 以上推奨）
- Camera V3（オートフォーカス対応、CSI 接続）
- 16×2 文字 LCD（LCD1602 互換）＋ I²C バックパック（PCF8574 系）
- 配線材（ジャンパワイヤ）

### 5.2 接続・電気仕様
- カメラ：CSI フラットケーブルで Pi 5 カメラポートに接続
- LCD（I²C）：
  - Pi 側 I²C バス（I2C-1）：SDA=GPIO2、SCL=GPIO3
  - VCC/GND：LCD は 5V 給電可。ただし **I²C のプルアップ電圧は 3.3V** とする（5V プルアップは Pi を損傷する恐れ）。必要に応じてレベル変換または 3.3V プルアップへ変更。
  - 典型 I²C アドレス：0x27 または 0x3F（設定で変更可）

## 6. ソフトウェア要件
### 6.1 言語・フレームワーク
- Python 3.11+
- 主要ライブラリ：
  - 物体検出：`ultralytics`（YOLOv8/YOLOv5 互換の軽量モデルを使用）
  - 画像処理／カメラ：`opencv-python`、`libcamera`（`picamera2` も可）
  - I²C/LCD：`smbus2`＋LCD ライブラリ（`RPLCD` など）
  - 設定：`pyyaml`、ログ：`loguru` など

### 6.2 モデル
- 既成の COCO 学習済み軽量モデル（例：`yolov8n`）を採用
- モデルファイルは初回起動時に自動取得、もしくは `models/` に配置

### 6.3 OS/ミドルウェア
- Raspberry Pi OS (64-bit) 最新安定版
- `libcamera`/`gstreamer` の導入（Camera V3 駆動）
- I²C 有効化（`raspi-config` または `config.txt`）

## 7. 機能要件
### 7.1 カメラ入力
- 解像度は初期値 640×480〜1280×720 の範囲で設定可能
- FPS 目標：10〜20 FPS（軽量モデル時、最適化前提）

### 7.2 物体検出
- 各フレームで YOLO 推論を実行
- 複数クラス検出時の表示優先：
  1) 最大信頼度クラス 2) 面積が大きいクラス 3) 固定優先度テーブル
- 表示対象は 1〜2 クラスまで（LCD の物理制約に合わせる）

### 7.3 LCD 表示
- 1 行目：最上位クラス名（英語 → 日本語表記変換テーブルを任意で用意）
- 2 行目：推定信頼度（%）または FPS 表示
- 16 文字制限に合わせ、長いクラス名は省略（例：`person`→`Person`、`sports ball`→`Ball`）
- I²C アドレス自動検出（失敗時は設定値を使用）

### 7.4 ログ・監視
- コンソールとファイルへ INFO/ERROR を出力
- 起動時の構成情報（解像度、モデル、I²C アドレス）を記録

### 7.5 エラー処理
- カメラ未接続／ビジー時の再試行と明示的なエラーメッセージ
- LCD 未検出時：アプリ継続（画面出力スキップ）またはフェイルセーフ終了を選択可
- モデル未取得時：ネットワーク接続案内とリトライ

## 8. 非機能要件
- パフォーマンス：軽量モデルで 10FPS 以上を目標（Pi 5 標準クロック、解像度 640×480 前提）
- 可搬性：Raspberry Pi 5 上で再現可能、将来 Hailo など外部アクセラレータに拡張可能
- 信頼性：長時間連続稼働（8 時間）での安定動作
- セキュリティ・プライバシ：映像はローカル処理。クラウド送信は行わない（オプトインで将来拡張）

## 9. ユーザーインタフェース
- 物理 UI：LCD 表示のみ（必要に応じて停止ボタンを GPIO へ拡張）
- ソフト UI：CLI 引数（解像度、クラス優先、LCD アドレス、表示モード など）

## 10. 設定項目（スクリプト内定数として定義）
```python
# 設定定数（yolo_picamera_detector.py内で定義）
CAMERA_WIDTH = 640
CAMERA_HEIGHT = 480
CAMERA_FPS = 20

MODEL_NAME = "yolov8n"
CONF_THRESHOLD = 0.5
IOU_THRESHOLD = 0.45

LCD_I2C_BUS = 1
LCD_ADDRESS = 0x27
LCD_COLS = 16
LCD_ROWS = 2

MAX_LABELS = 2
LABEL_LANG = "ja"  # ja | en
```

※ 教材として理解しやすくするため、外部設定ファイルは使用せず、スクリプト内で定数として定義

## 11. 画面・表示仕様（LCD）
- 1 行目（例）：`Person 95%`
- 2 行目（例）：`FPS: 14.2`
- 日本語表示を行う場合はカナ英数に限定（LCD 文字 ROM 依存）。全角は基本使用しない。

## 12. システム構成／データフロー
1) Camera V3 → 2) フレーム取得（OpenCV/Libcamera） → 3) YOLO 推論 → 4) クラス選定 → 5) LCD 文字列整形 → 6) I²C 書き込み

## 13. 開発体制・品質保証
- コーディング規約：PEP8 準拠、シンプルで読みやすいコード（教材向け）
- テスト：基本的な動作確認（単一ファイル構成のため、シンプルなテストに留める）
- 実機テスト：屋内/屋外での検出精度、FPS 測定、8 時間連続稼働

## 14. 導入手順（概要）
1. OS 更新、カメラ・I²C 有効化
2. 依存パッケージ導入（Python venv、OpenCV、ultralytics、RPLCD 等）
3. リポジトリ取得、`requirements.txt` でインストール
4. 必要に応じて `yolo_picamera_detector.py` 内の設定定数を調整
5. 実行：`python yolo_picamera_detector.py`
6. 任意：systemd 登録で自動起動

## 15. 受け入れ基準
- Pi 5 単体で 640×480, `yolov8n` 使用時に **10FPS 以上** を達成
- 人（person）・ボトル（bottle）・椅子（chair）等、COCO の代表クラスで最低 3 種を正しく表示
- LCD に 1〜2 件のクラスが崩れずに表示される（16 文字制約に収まる）
- 異常系（カメラ未接続、LCD 未検出）で適切なメッセージ出力

## 16. リスク・前提
- LCD の I²C プルアップ電圧が 5V の個体があるため、**3.3V への変更またはレベル変換**が必要
- 高解像度・重いモデルでは FPS 低下（必要に応じて解像度やモデルを調整）
- 照明条件により検出精度が変動

## 17. 将来拡張（任意）
- Hailo-8L 等アクセラレータ対応による高速化
- Web ストリーミング表示／REST API 連携
- クラス名の日本語辞書拡充とスクロール表示
- 画像・検出ログの保存と可視化（Grafana/Prometheus 等）

---
最終更新日：2025-09-27
担当：むらさん（想定） / 開発言語：Python

